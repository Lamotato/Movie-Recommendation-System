# 电影推荐系统 - 模块划分与实现计划

## 一、模块划分总览

### 1.1 后端模块结构
```
com.project.platform
├── config/              # 配置类
├── controller/          # 控制器层
│   ├── common/         # 通用接口（登录、注册）
│   ├── user/           # 用户接口
│   ├── admin/          # 管理员接口
│   ├── movie/          # 电影接口
│   ├── cinema/         # 影院接口
│   ├── order/          # 订单接口
│   ├── recommendation/ # 推荐接口 ⭐
│   └── behavior/       # 行为采集接口
├── service/            # 服务层
│   ├── UserService
│   ├── MovieService
│   ├── CinemaService
│   ├── OrderService
│   ├── RecommendationService ⭐
│   └── BehaviorService
├── mapper/             # 数据访问层
├── entity/             # 实体类
├── dto/                # 数据传输对象
├── vo/                 # 视图对象
├── utils/              # 工具类
│   └── RecommendationUtils ⭐
└── exception/          # 异常处理
```

## 二、模块详细设计

### 模块1：用户认证与权限管理

#### 1.1 功能清单
- [x] 用户注册（邮箱注册）
- [x] 用户登录（JWT认证）
- [ ] 密码重置（邮箱验证码）
- [ ] 权限控制（普通用户/管理员）
- [ ] 用户信息管理

#### 1.2 实体类
- `User` - 用户表
- `Admin` - 管理员表（已存在）

#### 1.3 Controller接口
```
POST   /common/register          # 用户注册
POST   /common/login             # 用户登录
POST   /common/retrievePassword  # 密码重置
GET    /user/info                # 获取当前用户信息
PUT    /user/info                # 更新用户信息
PUT    /user/password            # 修改密码
```

#### 1.4 Service方法
```java
public interface UserService {
    void register(UserRegisterDTO dto);
    String login(LoginDTO dto);
    void updatePassword(UpdatePasswordDTO dto);
    void retrievePassword(RetrievePasswordDTO dto);
    UserVO getCurrentUserInfo();
    void updateUserInfo(UserUpdateDTO dto);
}
```

#### 1.5 实现要点
- 密码加密：使用BCrypt加密
- JWT生成：包含用户ID、角色、过期时间
- 邮箱验证：发送验证码（可集成阿里云邮件服务）
- 权限拦截：使用Spring拦截器

---

### 模块2：电影数据管理

#### 2.1 功能清单
- [ ] 电影类型管理（CRUD）
- [ ] 电影信息管理（CRUD，支持多类型）
- [ ] 电影标签管理
- [ ] 演职人员管理
- [ ] 电影数据校验
- [ ] 批量导入/导出

#### 2.2 实体类
- `Movie` - 电影表
- `MovieType` - 电影类型表
- `MovieTypeRelation` - 电影类型关联表
- `MovieTag` - 电影标签表
- `MovieTagRelation` - 电影标签关联表
- `MovieCast` - 演职人员表

#### 2.3 Controller接口
```
# 电影类型
GET    /admin/movie-type/list          # 列表
POST   /admin/movie-type/add           # 新增
PUT    /admin/movie-type/update        # 更新
DELETE /admin/movie-type/delete/{id}   # 删除

# 电影信息
GET    /admin/movie/page               # 分页查询
GET    /admin/movie/{id}               # 详情
POST   /admin/movie/add                # 新增
PUT    /admin/movie/update             # 更新
DELETE /admin/movie/delete/{id}        # 删除
POST   /admin/movie/batch-import       # 批量导入
GET    /admin/movie/export             # 导出

# 电影标签
GET    /admin/movie-tag/list           # 列表
POST   /admin/movie-tag/add            # 新增
PUT    /admin/movie-tag/update         # 更新
DELETE /admin/movie-tag/delete/{id}    # 删除

# 演职人员
GET    /admin/movie-cast/list/{movieId} # 列表
POST   /admin/movie-cast/add            # 新增
PUT    /admin/movie-cast/update         # 更新
DELETE /admin/movie-cast/delete/{id}    # 删除
```

#### 2.4 Service方法
```java
public interface MovieService {
    // 电影类型
    List<MovieTypeVO> getMovieTypeList();
    void addMovieType(MovieTypeDTO dto);
    void updateMovieType(MovieTypeDTO dto);
    void deleteMovieType(Integer id);
    
    // 电影信息
    PageVO<MovieVO> getMoviePage(Map<String, Object> query, int pageNum, int pageSize);
    MovieVO getMovieById(Integer id);
    void addMovie(MovieDTO dto);
    void updateMovie(MovieDTO dto);
    void deleteMovie(Integer id);
    void batchImportMovies(MultipartFile file);
    
    // 电影标签
    List<MovieTagVO> getMovieTagList();
    void addMovieTag(MovieTagDTO dto);
    void updateMovieTag(MovieTagDTO dto);
    void deleteMovieTag(Integer id);
    
    // 演职人员
    List<MovieCastVO> getMovieCastList(Integer movieId);
    void addMovieCast(MovieCastDTO dto);
    void updateMovieCast(MovieCastDTO dto);
    void deleteMovieCast(Integer id);
}
```

#### 2.5 数据校验规则
- 电影名称：必填，长度1-200
- 电影类型：必填，1-3个类型
- 海报URL：格式校验
- 评分：0-10之间
- 上映日期：不能晚于当前日期

---

### 模块3：影院与订单管理

#### 3.1 功能清单
- [ ] 影院管理（注册、认证）
- [ ] 房间管理
- [ ] 座位管理
- [ ] 放映场次管理（审批）
- [ ] 在线选座
- [ ] 订单管理

#### 3.2 实体类
- `Cinema` - 影院表
- `CinemaRoom` - 房间表
- `Seat` - 座位表
- `Screening` - 放映场次表
- `Order` - 订单表
- `OrderDetail` - 订单明细表

#### 3.3 Controller接口
```
# 影院
GET    /admin/cinema/page              # 分页查询
POST   /admin/cinema/add               # 新增
PUT    /admin/cinema/update            # 更新
PUT    /admin/cinema/approve/{id}      # 审批通过
DELETE /admin/cinema/delete/{id}       # 删除

# 房间
GET    /admin/cinema-room/list/{cinemaId} # 列表
POST   /admin/cinema-room/add              # 新增
PUT    /admin/cinema-room/update           # 更新
DELETE /admin/cinema-room/delete/{id}      # 删除

# 放映场次
GET    /admin/screening/page           # 分页查询
POST   /admin/screening/add            # 新增
PUT    /admin/screening/approve/{id}   # 审批通过
DELETE /admin/screening/delete/{id}    # 删除

# 选座购票（用户端）
GET    /user/screening/{id}/seats      # 获取场次座位信息
POST   /user/order/create              # 创建订单
GET    /user/order/list                # 订单列表
GET    /user/order/{orderNo}           # 订单详情
PUT    /user/order/cancel/{orderNo}    # 取消订单
```

#### 3.4 业务逻辑
- **选座逻辑**：检查座位是否已被占用
- **订单创建**：锁定座位，生成订单号
- **订单支付**：更新订单状态，解锁座位
- **订单取消**：仅未取票订单可取消

---

### 模块4：用户行为采集 ⭐

#### 4.1 功能清单
- [ ] 行为数据采集接口
- [ ] 行为数据存储
- [ ] 行为数据统计

#### 4.2 行为类型
- `browse` - 浏览电影详情
- `rate` - 评分
- `favorite` - 收藏/取消收藏
- `comment` - 评论
- `search` - 搜索
- `order` - 下单

#### 4.3 Controller接口
```
POST   /behavior/record                # 记录用户行为
GET    /behavior/statistics/{userId}   # 用户行为统计
```

#### 4.4 Service方法
```java
public interface BehaviorService {
    void recordBehavior(UserBehaviorDTO dto);
    UserBehaviorStatisticsVO getStatistics(Integer userId);
    List<UserBehaviorVO> getUserBehaviors(Integer userId, String behaviorType, int limit);
}
```

#### 4.5 实现要点
- **异步处理**：使用@Async异步记录行为，避免影响主流程
- **批量插入**：使用批量插入优化性能
- **数据清洗**：过滤无效行为（如重复浏览）

---

### 模块5：混合推荐引擎 ⭐⭐⭐（核心模块）

#### 5.1 功能清单
- [ ] 用户画像分析（新用户/轻度/重度）
- [ ] 协同过滤推荐
- [ ] 内容推荐
- [ ] 热门推荐
- [ ] 实时推荐
- [ ] 推荐结果融合
- [ ] 推荐结果缓存

#### 5.2 实体类
- `RecommendationResult` - 推荐结果表
- `RecommendationEvaluation` - 推荐效果评估表

#### 5.3 Controller接口
```
GET    /recommendation/guess-you-like   # 猜你喜欢（首页推荐）
GET    /recommendation/collaborative    # 协同过滤推荐
GET    /recommendation/content          # 内容推荐
GET    /recommendation/popular          # 热门推荐
GET    /recommendation/realtime         # 实时推荐
POST   /recommendation/refresh          # 刷新推荐（管理员）
```

#### 5.4 Service方法
```java
public interface RecommendationService {
    // 核心推荐接口
    List<MovieVO> getGuessYouLike(Integer userId, int limit);
    List<MovieVO> getCollaborativeRecommendation(Integer userId, int limit);
    List<MovieVO> getContentRecommendation(Integer userId, int limit);
    List<MovieVO> getPopularRecommendation(int limit);
    List<MovieVO> getRealTimeRecommendation(Integer userId, int limit);
    
    // 推荐策略选择
    RecommendationStrategy selectStrategy(Integer userId);
    
    // 推荐结果融合
    List<MovieVO> mergeRecommendations(List<RecommendationResult> results, Map<String, Double> weights);
    
    // 推荐结果缓存
    void cacheRecommendation(Integer userId, String type, List<MovieVO> movies);
    List<MovieVO> getCachedRecommendation(Integer userId, String type);
    
    // 推荐效果评估
    RecommendationEvaluationVO evaluateRecommendation(String type, Date date);
}
```

#### 5.5 工具类
```java
public class RecommendationUtils {
    // 用户画像分析
    public static UserProfile analyzeUserProfile(Integer userId);
    
    // 相似度计算
    public static double cosineSimilarity(double[] vec1, double[] vec2);
    public static double jaccardSimilarity(Set<Integer> set1, Set<Integer> set2);
    
    // 时间衰减
    public static double timeDecay(LocalDateTime behaviorTime, double lambda);
    
    // 多样性保证
    public static List<MovieVO> ensureDiversity(List<MovieVO> movies, int maxSameType);
}
```

#### 5.6 推荐算法实现类
```java
@Component
public class CollaborativeFilteringRecommender {
    public List<MovieVO> recommend(Integer userId, int limit);
    private List<Integer> findSimilarUsers(Integer userId, int k);
    private Map<Integer, Double> predictRatings(Integer userId, List<Integer> similarUsers);
}

@Component
public class ContentBasedRecommender {
    public List<MovieVO> recommend(Integer userId, int limit);
    private Map<Integer, Double> calculateMovieSimilarity(Integer movieId, List<Integer> candidateMovies);
}

@Component
public class PopularRecommender {
    public List<MovieVO> recommend(int limit);
    private double calculatePopularityScore(Movie movie);
}

@Component
public class RealTimeRecommender {
    public List<MovieVO> recommend(Integer userId, int limit);
    private List<UserBehavior> getRecentBehaviors(Integer userId, int days);
}
```

#### 5.7 实现要点
- **策略选择**：根据用户行为数据量动态选择推荐策略
- **并行计算**：使用CompletableFuture并行执行多个推荐算法
- **缓存优化**：推荐结果缓存到Redis，过期时间1小时
- **性能优化**：限制计算范围（Top-K相似用户/电影）

---

### 模块6：推荐效果评估

#### 6.1 功能清单
- [ ] 准确率、召回率计算
- [ ] 用户满意度统计
- [ ] 推荐多样性计算
- [ ] 可视化报表

#### 6.2 Controller接口
```
GET    /admin/recommendation/evaluation        # 评估结果列表
GET    /admin/recommendation/evaluation/{date} # 指定日期评估结果
POST   /admin/recommendation/evaluate          # 手动触发评估
GET    /admin/recommendation/statistics        # 推荐统计报表
```

#### 6.3 Service方法
```java
public interface RecommendationEvaluationService {
    RecommendationEvaluationVO evaluate(String type, Date date);
    List<RecommendationEvaluationVO> getEvaluationHistory(String type, Date startDate, Date endDate);
    RecommendationStatisticsVO getStatistics(Date startDate, Date endDate);
}
```

---

### 模块7：用户端功能

#### 7.1 功能清单
- [ ] 首页（热门电影、待放映、猜你喜欢、排行榜、今日票房）
- [ ] 电影列表（多维度筛选）
- [ ] 电影详情
- [ ] 在线选座
- [ ] 订单管理
- [ ] 收藏管理
- [ ] 电影评分

#### 7.2 Controller接口
```
# 首页
GET    /front/home                    # 首页数据
GET    /front/movie/hot               # 热门电影
GET    /front/movie/upcoming          # 待放映电影
GET    /front/movie/ranking           # 电影排行榜
GET    /front/box-office/today        # 今日票房

# 电影
GET    /front/movie/page              # 电影列表（支持筛选）
GET    /front/movie/{id}              # 电影详情
GET    /front/movie/{id}/similar      # 相似电影

# 收藏
POST   /front/favorite/add/{movieId}  # 添加收藏
DELETE /front/favorite/delete/{movieId} # 取消收藏
GET    /front/favorite/list           # 收藏列表

# 评分
POST   /front/rating/add              # 添加评分
PUT    /front/rating/update           # 更新评分
GET    /front/rating/{movieId}        # 获取评分
```

---

### 模块8：管理员后台

#### 8.1 功能清单
- [ ] 系统首页（数据统计、图表）
- [ ] 电影管理
- [ ] 影院管理
- [ ] 订单管理
- [ ] 用户管理
- [ ] 公告管理
- [ ] 推荐效果评估

#### 8.2 Controller接口
```
GET    /admin/dashboard/statistics    # 数据统计
GET    /admin/dashboard/charts        # 图表数据
```

---

## 三、开发优先级与迭代计划

### 迭代1：基础框架（1周）
**目标**：完成数据库设计和基础功能

**任务**：
1. ✅ 数据库表结构设计
2. 创建所有Entity实体类
3. 创建基础Mapper接口
4. 实现用户注册、登录功能
5. 实现管理员基础CRUD

**交付物**：
- 数据库SQL文件
- 基础实体类
- 用户认证功能

---

### 迭代2：电影管理模块（1周）
**目标**：完成电影数据的增删改查

**任务**：
1. 电影类型管理
2. 电影信息管理（支持多类型关联）
3. 演职人员管理
4. 电影标签管理
5. 数据校验功能

**交付物**：
- MovieService完整实现
- 电影管理接口

---

### 迭代3：影院与订单模块（1周）
**目标**：完成影院、选座、订单功能

**任务**：
1. 影院管理
2. 房间管理
3. 放映场次管理
4. 在线选座功能
5. 订单管理

**交付物**：
- CinemaService、OrderService实现
- 选座购票功能

---

### 迭代4：用户行为采集（3天）
**目标**：记录用户行为数据

**任务**：
1. 行为数据采集接口
2. 行为数据存储
3. 行为数据统计

**交付物**：
- BehaviorService实现
- 行为采集接口

---

### 迭代5：推荐引擎核心（2周）⭐⭐⭐
**目标**：实现混合推荐算法

**任务**：
1. 用户画像计算（新用户/轻度/重度）
2. 协同过滤算法实现
3. 内容推荐算法实现
4. 热门推荐算法实现
5. 实时推荐算法实现
6. 推荐结果融合
7. Redis缓存推荐结果

**交付物**：
- RecommendationService完整实现
- 推荐算法工具类
- 推荐接口

---

### 迭代6：推荐效果评估（1周）
**目标**：评估推荐效果

**任务**：
1. 准确率、召回率计算
2. 用户满意度统计
3. 推荐多样性计算
4. 可视化报表

**交付物**：
- 推荐效果评估功能
- 统计报表接口

---

### 迭代7：前端开发（2周）
**目标**：完成前端页面

**任务**：
1. 用户端首页（含推荐）
2. 电影列表、详情页
3. 选座购票页面
4. 订单管理页面
5. 管理员后台

**交付物**：
- 完整前端页面
- 前后端联调

---

## 四、技术难点与解决方案

### 4.1 推荐算法性能优化
**问题**：协同过滤计算量大，响应慢
**方案**：
- 预计算推荐结果，存储到Redis
- 使用增量更新，只计算变化部分
- 限制推荐列表长度（Top-N）

### 4.2 冷启动问题
**问题**：新用户、新电影无历史数据
**方案**：
- 新用户：基于注册兴趣标签推荐
- 新电影：基于类型、演员推荐相似电影
- 热门推荐兜底

### 4.3 实时性要求
**问题**：用户行为后需要快速更新推荐
**方案**：
- 实时推荐单独计算，不依赖离线模型
- 使用Redis存储最近行为
- 异步更新推荐结果

---

## 五、依赖与配置

### 5.1 新增依赖（pom.xml）
```xml
<!-- Redis -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>

<!-- 邮件服务（可选） -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-mail</artifactId>
</dependency>
```

### 5.2 配置文件（application.yaml）
```yaml
spring:
  redis:
    host: localhost
    port: 6379
    password: 
    database: 0
    timeout: 3000ms
    lettuce:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0

recommendation:
  cache:
    expire-time: 3600  # 推荐结果缓存过期时间（秒）
  algorithm:
    collaborative:
      k: 100  # 相似用户/电影数量
    content:
      max-similar: 50  # 最大相似电影数
    realtime:
      days: 7  # 实时推荐时间窗口（天）
```
