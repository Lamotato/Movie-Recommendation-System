<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.platform.mapper.OrderMapper">

    <select id="queryPage" resultType="com.project.platform.entity.Order">
        SELECT o.*
        FROM `order` o
        <include refid="queryConditions"/>
        ORDER BY o.create_time DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <select id="queryCount" resultType="int">
        SELECT count(o.id) FROM `order` o
        <include refid="queryConditions"/>
    </select>

    <!-- 根据订单号查询 -->
    <select id="selectByOrderNo" resultType="com.project.platform.entity.Order">
        SELECT * FROM `order` WHERE order_no = #{orderNo}
    </select>

    <!-- 根据用户ID查询订单列表 -->
    <select id="listByUserId" resultType="com.project.platform.entity.Order">
        SELECT * FROM `order` WHERE user_id = #{userId} ORDER BY create_time DESC
    </select>

    <!-- 根据ID查询 -->
    <select id="selectByPrimaryKey" resultType="com.project.platform.entity.Order">
        SELECT * FROM `order` WHERE id = #{id}
    </select>

    <sql id="queryConditions">
        <where>
            <if test="query.userId != null">
                AND o.user_id = #{query.userId}
            </if>
            <if test="query.screeningId != null">
                AND o.screening_id = #{query.screeningId}
            </if>
            <if test="query.status != null and query.status.trim() != ''">
                AND o.status = #{query.status}
            </if>
            <if test="query.orderNo != null and query.orderNo.trim() != ''">
                AND o.order_no LIKE CONCAT('%', #{query.orderNo}, '%')
            </if>
        </where>
    </sql>

    <!-- 插入 -->
    <insert id="insert" parameterType="com.project.platform.entity.Order" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `order`
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="orderNo != null">order_no,</if>
            <if test="userId != null">user_id,</if>
            <if test="screeningId != null">screening_id,</if>
            <if test="totalAmount != null">total_amount,</if>
            <if test="seatCount != null">seat_count,</if>
            <if test="status != null">status,</if>
            <if test="payTime != null">pay_time,</if>
            <if test="ticketTime != null">ticket_time,</if>
        </trim>
        VALUES
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="orderNo != null">#{orderNo},</if>
            <if test="userId != null">#{userId},</if>
            <if test="screeningId != null">#{screeningId},</if>
            <if test="totalAmount != null">#{totalAmount},</if>
            <if test="seatCount != null">#{seatCount},</if>
            <if test="status != null">#{status},</if>
            <if test="payTime != null">#{payTime},</if>
            <if test="ticketTime != null">#{ticketTime},</if>
        </trim>
    </insert>

    <!-- 更新 -->
    <update id="updateById" parameterType="com.project.platform.entity.Order">
        UPDATE `order`
        <set>
            <if test="orderNo != null">order_no = #{orderNo},</if>
            <if test="userId != null">user_id = #{userId},</if>
            <if test="screeningId != null">screening_id = #{screeningId},</if>
            <if test="totalAmount != null">total_amount = #{totalAmount},</if>
            <if test="seatCount != null">seat_count = #{seatCount},</if>
            <if test="status != null">status = #{status},</if>
            <if test="payTime != null">pay_time = #{payTime},</if>
            <if test="ticketTime != null">ticket_time = #{ticketTime},</if>
        </set>
        WHERE id = #{id}
    </update>

</mapper>
